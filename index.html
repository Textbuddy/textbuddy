<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TextBuddy Pro - Student Writing Assistant</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{
      --primary:#15c39a; --secondary:#4a6cf7; --error:#f56565;
      --bg:#f6f7fb; --card:#ffffff; --text:#1f2732; --muted:#738091;
      --ring:0 8px 24px rgba(21,195,154,.25); --soft:0 4px 16px rgba(0,0,0,.08);
    }
    body.dark{
      --bg:#0f1623; --card:#121a2a; --text:#e7eefb; --muted:#a7b4c9;
      --primary:#38b2ac; --secondary:#7aa2ff; --error:#ff7b7b;
      --ring:0 8px 24px rgba(56,178,172,.25); --soft:0 4px 16px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);transition:.25s background,.25s color}
    header{
      position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--card),rgba(255,255,255,0));
      backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid rgba(0,0,0,.06);
    }
    .bar{
      max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px;justify-content:space-between
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 0 6px rgba(21,195,154,.15)}
    .brand span{letter-spacing:.3px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    select, .input{
      appearance:none;background:var(--card);color:var(--text);border:1px solid rgba(0,0,0,.08);
      padding:8px 12px;border-radius:10px;font-weight:600;box-shadow:var(--soft);outline:none
    }
    .btn{
      border:0;border-radius:12px;padding:9px 14px;font-weight:700;cursor:pointer;
      background:var(--primary);color:#fff;box-shadow:var(--ring);transition:.2s transform,.2s box-shadow
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:linear-gradient(180deg,#eef2ff,#e7ecff);color:#23324d}
    body.dark .btn.secondary{background:#2b3750;color:#e7eefb}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,.08)}
    .toggle{width:44px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center}
    main{max-width:1200px;margin:24px auto;display:grid;grid-template-columns:1fr 320px;gap:18px;padding:0 18px}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--soft)}
    .editor-header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.06)}
    .editor{min-height:360px;padding:18px;outline:none;line-height:1.7;font-size:1.02rem}
    .editor:empty:before{content:"Paste or type your essay here...";color:var(--muted)}
    .editor-footer{display:flex;gap:14px;align-items:center;justify-content:flex-end;padding:10px 14px;border-top:1px solid rgba(0,0,0,.06);color:var(--muted);font-weight:600}
    .chip{background:rgba(0,0,0,.06);padding:6px 10px;border-radius:999px}
    body.dark .chip{background:#1d2740}
    .sidebar{padding:14px}
    .side-head{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 12px}
    .side-title{font-size:1.05rem;font-weight:800}
    .suggestions{display:flex;flex-direction:column;gap:10px}
    .suggestion{padding:10px 12px;border:1px dashed rgba(0,0,0,.08);border-radius:12px}
    .badge{font-size:.74rem;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#243560;font-weight:700}
    body.dark .badge{background:#2b3750;color:#bcd0ff}
    .highlight{background:rgba(245,101,101,.22);border-bottom:2px dashed var(--error);border-radius:6px;padding:0 2px;cursor:pointer}
    .donate{margin-top:16px;padding:14px;border-radius:14px;background:linear-gradient(135deg,rgba(21,195,154,.15),rgba(74,108,247,.12))}
    .donate .btn{width:100%}
    .tips{font-size:.82rem;color:var(--muted);margin-top:8px}
    
    /* New styles for additional features */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .tool-btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid rgba(0,0,0,.08);
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s;
    }
    .tool-btn:hover {
      background: var(--primary);
      color: white;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 20;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
    }
    .citation-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .citation-form input, .citation-form select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,.1);
      background: var(--bg);
      color: var(--text);
    }
    .citation-result {
      margin-top: 15px;
      padding: 15px;
      background: var(--bg);
      border-radius: 8px;
      font-family: monospace;
    }
    .timer-display {
      font-size: 2rem;
      text-align: center;
      margin: 15px 0;
      font-weight: bold;
    }
    .timer-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .stat-box {
      padding: 10px;
      background: var(--bg);
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }
    .tab-container {
      margin-top: 15px;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid rgba(0,0,0,.1);
      margin-bottom: 15px;
    }
    .tab-btn {
      padding: 8px 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .history-item {
      padding: 10px;
      border-bottom: 1px solid rgba(0,0,0,.1);
      cursor: pointer;
    }
    .history-item:hover {
      background: var(--bg);
    }
    .export-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .word-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
      justify-content: center;
    }
    .cloud-word {
      padding: 4px 8px;
      border-radius: 20px;
      background: var(--primary);
      color: white;
      font-size: 0.9rem;
    }
    .text-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    .comparison-editor {
      min-height: 200px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,.1);
      border-radius: 8px;
      background: var(--bg);
    }
    .flashcard {
      perspective: 1000px;
      margin-bottom: 15px;
    }
    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 150px;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      cursor: pointer;
    }
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      padding: 15px;
      box-shadow: var(--soft);
    }
    .flashcard-front {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }
    .flashcard-back {
      background: var(--card);
      color: var(--text);
      transform: rotateY(180deg);
    }
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    .progress-bar {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    @media (max-width:980px){
      main{grid-template-columns:1fr}
      .tools-grid, .stats-grid, .export-options {
        grid-template-columns: 1fr;
      }
      .text-comparison {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><span class="dot"></span><span id="app-title">TextBuddy Pro - Student Writing Assistant</span></div>
      <div class="controls">
        <select id="ui-language-select" title="UI Language">
          <option value="en">English</option>
          <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
          <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
        </select>
        <button id="dark-toggle" class="btn toggle" title="Toggle theme">üåô</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Editor -->
    <section class="card">
      <div class="editor-header">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <strong id="label-write">Write your text:</strong>
          <select id="language-select" title="Grammar language">
            <option value="en-US">English (US)</option>
            <option value="en-GB">English (UK)</option>
            <option value="ur">Urdu (ÿßÿ±ÿØŸà)</option>
            <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
            <option value="fr">Fran√ßais</option>
            <option value="es">Espa√±ol</option>
            <option value="de">Deutsch</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="check-grammar">Check Grammar</button>
          <button class="btn secondary" id="fix-all">Fix All</button>
          <button class="btn secondary" id="text-tools-btn">Text Tools</button>
          <button class="btn secondary" id="citation-btn">Citation</button>
          <button class="btn secondary" id="download-doc">Download Word</button>
          <button class="btn secondary" id="download-pdf">Download PDF</button>
          <button class="btn secondary" id="plagiarism-check">Check Plagiarism</button>
        </div>
      </div>

      <div id="text-editor" class="editor" contenteditable="true"></div>

      <div class="editor-footer">
        <span class="chip" id="label-words">Words: <b id="word-count">0</b></span>
        <span class="chip" id="label-chars">Characters: <b id="char-count">0</b></span>
        <span class="chip" id="label-issues">Issues: <b id="issues-count">0</b></span>
        <span class="chip" id="label-reading-time">Reading Time: <b id="reading-time">0 min</b></span>
      </div>
    </section>

    <!-- Sidebar -->
    <aside class="card sidebar">
      <div class="side-head">
        <div class="side-title" id="label-suggestions">Writing Assistant</div>
        <span class="badge" id="label-live">Live</span>
      </div>
      
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="suggestions">Suggestions</button>
          <button class="tab-btn" data-tab="stats">Statistics</button>
          <button class="tab-btn" data-tab="tools">Study Tools</button>
          <button class="tab-btn" data-tab="learning">Learning</button>
        </div>
        
        <div id="suggestions-tab" class="tab-content active">
          <div id="suggestions-container" class="suggestions"></div>
        </div>
        
        <div id="stats-tab" class="tab-content">
          <div class="stats-grid">
            <div class="stat-box">
              <div>Readability Score</div>
              <div class="stat-value" id="readability-score">-</div>
            </div>
            <div class="stat-box">
              <div>Grade Level</div>
              <div class="stat-value" id="grade-level">-</div>
            </div>
            <div class="stat-box">
              <div>Sentences</div>
              <div class="stat-value" id="sentence-count">0</div>
            </div>
            <div class="stat-box">
              <div>Paragraphs</div>
              <div class="stat-value" id="paragraph-count">0</div>
            </div>
          </div>
          <div class="tips" style="margin-top: 15px; text-align: center;">
            Based on Flesch-Kincaid readability tests
          </div>
          
          <div style="margin-top: 20px;">
            <h4>Word Frequency</h4>
            <div class="word-cloud" id="word-cloud"></div>
          </div>
        </div>
        
        <div id="tools-tab" class="tab-content">
          <div class="tools-grid">
            <button class="tool-btn" id="summarize-btn">Summarize</button>
            <button class="tool-btn" id="vocab-btn">Vocabulary</button>
            <button class="tool-btn" id="outline-btn">Create Outline</button>
            <button class="tool-btn" id="timer-btn">Study Timer</button>
            <button class="tool-btn" id="compare-btn">Compare Texts</button>
            <button class="tool-btn" id="history-btn">History</button>
            <button class="tool-btn" id="flashcard-btn">Create Flashcards</button>
            <button class="tool-btn" id="word-goal-btn">Set Word Goal</button>
          </div>
          
          <div class="export-options">
            <button class="tool-btn" id="export-md">Export Markdown</button>
            <button class="tool-btn" id="export-latex">Export LaTeX</button>
            <button class="tool-btn" id="export-txt">Export Text</button>
            <button class="tool-btn" id="export-html">Export HTML</button>
          </div>
        </div>
        
        <div id="learning-tab" class="tab-content">
          <h4>Learning Progress</h4>
          <div class="progress-bar">
            <div class="progress-fill" id="learning-progress" style="width: 30%"></div>
          </div>
          <div class="tips" style="text-align: center; margin-top: 5px;">
            Based on your writing activity
          </div>
          
          <div style="margin-top: 20px;">
            <h4>Today's Writing Goal</h4>
            <div class="progress-bar">
              <div class="progress-fill" id="word-goal-progress" style="width: 45%"></div>
            </div>
            <div class="tips" style="text-align: center; margin-top: 5px;">
              225 of 500 words
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <h4>Quick Flashcards</h4>
            <div class="flashcard" id="flashcard-1">
              <div class="flashcard-inner">
                <div class="flashcard-front">
                  <div>What is a thesis statement?</div>
                </div>
                <div class="flashcard-back">
                  <div>A thesis statement is a sentence that summarizes the main point of your essay and previews your supporting points.</div>
                </div>
              </div>
            </div>
            <div class="tips" style="text-align: center;">
              Click to flip the card
            </div>
          </div>
        </div>
      </div>

      <div class="donate">
        <p id="label-support" style="margin:0 0 10px 0;font-weight:700">üôè Support this free tool</p>
        <a href="https://destream.net/live/Idrees4218/donate" target="_blank" rel="noopener">
          <button class="btn" id="label-donate">üíñ Donate on DeStream</button>
        </a>
        <div class="tips">Even a small tip helps keep the API running for students.</div>
      </div>
    </aside>
  </main>

  <!-- Modals for various features -->
  <div id="citation-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="citation-modal-title">Citation Generator</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="citation-form">
        <select id="citation-style">
          <option value="apa">APA</option>
          <option value="mla">MLA</option>
          <option value="chicago">Chicago</option>
        </select>
        <select id="source-type">
          <option value="book">Book</option>
          <option value="article">Journal Article</option>
          <option value="website">Website</option>
          <option value="other">Other</option>
        </select>
        <input type="text" id="author-name" placeholder="Author Name">
        <input type="text" id="source-title" placeholder="Title">
        <input type="text" id="publication-year" placeholder="Publication Year">
        <input type="text" id="publisher" placeholder="Publisher">
        <input type="text" id="url" placeholder="URL (for websites)">
        <button class="btn" id="generate-citation">Generate Citation</button>
      </div>
      <div class="citation-result" id="citation-result"></div>
    </div>
  </div>

  <div id="timer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Study Timer</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="timer-display" id="timer-display">25:00</div>
      <div class="timer-controls">
        <button class="btn" id="start-timer">Start</button>
        <button class="btn secondary" id="pause-timer">Pause</button>
        <button class="btn secondary" id="reset-timer">Reset</button>
      </div>
      <div style="margin-top: 15px;">
        <select id="timer-preset">
          <option value="25">Pomodoro (25 min)</option>
          <option value="15">Short Break (15 min)</option>
          <option value="5">Quick Break (5 min)</option>
          <option value="45">Deep Focus (45 min)</option>
        </select>
      </div>
    </div>
  </div>

  <div id="history-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Document History</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div id="history-list"></div>
    </div>
  </div>

  <div id="comparison-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Compare Texts</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="text-comparison">
        <div>
          <h4>Original Text</h4>
          <div class="comparison-editor" id="original-text" contenteditable="true"></div>
        </div>
        <div>
          <h4>Revised Text</h4>
          <div class="comparison-editor" id="revised-text" contenteditable="true"></div>
        </div>
      </div>
      <div style="margin-top: 15px; text-align: center;">
        <button class="btn" id="compare-texts-btn">Compare</button>
      </div>
      <div id="comparison-result" style="margin-top: 15px;"></div>
    </div>
  </div>

  <div id="flashcard-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Flashcards</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div>
        <p>Enter terms and definitions to create study flashcards:</p>
        <div id="flashcard-form">
          <input type="text" id="flashcard-term" placeholder="Term" style="width: 100%; margin-bottom: 10px; padding: 8px;">
          <textarea id="flashcard-definition" placeholder="Definition" style="width: 100%; height: 100px; padding: 8px;"></textarea>
          <button class="btn" id="add-flashcard" style="margin-top: 10px;">Add Flashcard</button>
        </div>
        <div id="flashcard-list" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <div id="word-goal-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Set Writing Goal</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div>
        <p>Set a daily word count goal to track your writing progress:</p>
        <input type="number" id="word-goal-input" placeholder="Word count goal" style="width: 100%; padding: 8px; margin-bottom: 10px;">
        <button class="btn" id="set-word-goal">Set Goal</button>
        <div id="word-goal-status" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== ELEMENTS ======
    const body = document.body;
    const editor = document.getElementById('text-editor');
    const suggestionsEl = document.getElementById('suggestions-container');
    const checkBtn = document.getElementById('check-grammar');
    const fixAllBtn = document.getElementById('fix-all');
    const wordCountEl = document.getElementById('word-count');
    const charCountEl = document.getElementById('char-count');
    const issuesCountEl = document.getElementById('issues-count');
    const readingTimeEl = document.getElementById('reading-time');
    const downloadDocBtn = document.getElementById('download-doc');
    const downloadPdfBtn = document.getElementById('download-pdf');
    const plagBtn = document.getElementById('plagiarism-check');
    const langSelect = document.getElementById('language-select');
    const uiLangSelect = document.getElementById('ui-language-select');
    const darkToggle = document.getElementById('dark-toggle');
    const textToolsBtn = document.getElementById('text-tools-btn');
    const citationBtn = document.getElementById('citation-btn');
    const citationModal = document.getElementById('citation-modal');
    const timerModal = document.getElementById('timer-modal');
    const historyModal = document.getElementById('history-modal');
    const comparisonModal = document.getElementById('comparison-modal');
    const flashcardModal = document.getElementById('flashcard-modal');
    const wordGoalModal = document.getElementById('word-goal-modal');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const closeModalBtns = document.querySelectorAll('.close-modal');

    // Statistics elements
    const readabilityScoreEl = document.getElementById('readability-score');
    const gradeLevelEl = document.getElementById('grade-level');
    const sentenceCountEl = document.getElementById('sentence-count');
    const paragraphCountEl = document.getElementById('paragraph-count');
    const wordCloudEl = document.getElementById('word-cloud');

    // ====== UI TRANSLATIONS ======
    const T = {
      en:{ title:"TextBuddy Pro - Student Writing Assistant", write:"Write your text:", words:"Words", chars:"Characters", issues:"Issues",
           suggestions:"Suggestions", live:"Live", support:"üôè Support this free tool",
           donate:"üíñ Donate on DeStream", check:"Check Grammar", fix:"Fix All",
           dword:"Download Word", dpdf:"Download PDF", plag:"Check Plagiarism",
           checking:"Checking...", allfixed:"All issues fixed ‚úÖ", clicktofix:"Click red highlights to apply fix",
           readingTime:"Reading Time", textTools:"Text Tools", citation:"Citation", 
           summarize:"Summarize", vocab:"Vocabulary", outline:"Create Outline", timer:"Study Timer",
           compare:"Compare Texts", history:"History", exportMd:"Export Markdown", exportLatex:"Export LaTeX",
           flashcards:"Create Flashcards", wordGoal:"Set Word Goal", exportTxt:"Export Text", exportHtml:"Export HTML" },
      ur:{ title:"Ÿπ€å⁄©ÿ≥Ÿπ ÿ®⁄à€å Ÿæÿ±Ÿà - ÿ∑ŸÑÿ®€Å ⁄©€í ŸÑ€å€í ÿ™ÿ≠ÿ±€åÿ±€å ŸÖÿπÿßŸàŸÜ", write:"ÿßŸæŸÜÿß ŸÖÿ™ŸÜ ŸÑ⁄©⁄æ€å⁄∫:", words:"ÿßŸÑŸÅÿßÿ∏", chars:"ÿ≠ÿ±ŸàŸÅ", issues:"ŸÖÿ≥ÿßÿ¶ŸÑ",
           suggestions:"ÿ™ÿ¨ÿßŸà€åÿ≤", live:"ŸÅÿπÿßŸÑ", support:"üôè ÿßÿ≥ ŸÖŸÅÿ™ ŸπŸàŸÑ ⁄©€å ŸÖÿØÿØ ⁄©ÿ±€å⁄∫",
           donate:"üíñ ⁄àŸàŸÜ€åŸπ ⁄©ÿ±€å⁄∫ (DeStream)", check:"⁄Øÿ±ÿßŸÖÿ± ⁄Ü€å⁄© ⁄©ÿ±€å⁄∫", fix:"ÿ≥ÿ® ÿØÿ±ÿ≥ÿ™ ⁄©ÿ±€å⁄∫",
           dword:"Ÿàÿ±⁄à ŸÅÿßÿ¶ŸÑ ⁄àÿßÿ§ŸÜŸÑŸà⁄à", dpdf:"PDF ⁄àÿßÿ§ŸÜŸÑŸà⁄à", plag:"ŸæŸÑ€åŸÜÿ¨ÿ±ÿ≤ŸÖ ⁄Ü€å⁄© ⁄©ÿ±€å⁄∫",
           checking:"⁄Ü€å⁄© €ÅŸà ÿ±€Åÿß €Å€í...", allfixed:"ÿ™ŸÖÿßŸÖ ÿ∫ŸÑÿ∑€åÿß⁄∫ ÿØÿ±ÿ≥ÿ™ ‚úÖ", clicktofix:"ÿØÿ±ÿ≥ÿ™⁄Ø€å ⁄©€åŸÑÿ¶€í €Åÿßÿ¶€å ŸÑÿßÿ¶Ÿπ Ÿæÿ± ⁄©ŸÑ⁄© ⁄©ÿ±€å⁄∫",
           readingTime:"Ÿæ⁄ë⁄æŸÜ€í ⁄©ÿß ŸàŸÇÿ™", textTools:"Ÿπ€å⁄©ÿ≥Ÿπ ŸπŸàŸÑÿ≤", citation:"ÿ≠ŸàÿßŸÑ€Å", 
           summarize:"ÿÆŸÑÿßÿµ€Å", vocab:"ŸÑŸÅÿ∏ÿßÿ™", outline:"ÿ¢ÿ§Ÿπ ŸÑÿßÿ¶ŸÜ ÿ®ŸÜÿßÿ¶€å⁄∫", timer:"ŸÖÿ∑ÿßŸÑÿπ€Å Ÿπÿßÿ¶ŸÖÿ±",
           compare:"ŸÖÿ™ŸÜ ⁄©ÿß ŸÖŸàÿßÿ≤ŸÜ€Å", history:"ÿ™ÿßÿ±€åÿÆ⁄Ü€Å", exportMd:"ŸÖÿßÿ±⁄© ⁄àÿßÿ§ŸÜ ÿ®ÿ±ÿ¢ŸÖÿØ ⁄©ÿ±€å⁄∫", exportLatex:"ŸÑ€åŸπ€å⁄© ÿ®ÿ±ÿ¢ŸÖÿØ ⁄©ÿ±€å⁄∫",
           flashcards:"ŸÅŸÑ€åÿ¥ ⁄©ÿßÿ±⁄àÿ≤ ÿ®ŸÜÿßÿ¶€å⁄∫", wordGoal:"ŸÑŸÅÿ∏Ÿà⁄∫ ⁄©ÿß €ÅÿØŸÅ ŸÖŸÇÿ±ÿ± ⁄©ÿ±€å⁄∫", exportTxt:"Ÿπ€å⁄©ÿ≥Ÿπ ÿ®ÿ±ÿ¢ŸÖÿØ ⁄©ÿ±€å⁄∫", exportHtml:"HTML ÿ®ÿ±ÿ¢ŸÖÿØ ⁄©ÿ±€å⁄∫" },
      hi:{ title:"‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü‡§¨‡§°‡•Ä ‡§™‡•ç‡§∞‡•ã - ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§≤‡•á‡§ñ‡§® ‡§∏‡§π‡§æ‡§Ø‡§ï", write:"‡§Ö‡§™‡§®‡§æ ‡§™‡§æ‡§† ‡§≤‡§ø‡§ñ‡•á‡§Ç:", words:"‡§∂‡§¨‡•ç‡§¶", chars:"‡§Ö‡§ï‡•ç‡§∑‡§∞", issues:"‡§ó‡§≤‡§§‡§ø‡§Ø‡§æ‡§Å",
           suggestions:"‡§∏‡•Å‡§ù‡§æ‡§µ", live:"‡§≤‡§æ‡§á‡§µ", support:"üôè ‡§á‡§∏ ‡§Æ‡•Å‡§´‡•ç‡§§ ‡§ü‡•Ç‡§≤ ‡§ï‡•ã ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç",
           donate:"üíñ DeStream ‡§™‡§∞ ‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç", check:"‡§ó‡•ç‡§∞‡§æ‡§Æ‡§∞ ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç", fix:"‡§∏‡§¨ ‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç",
           dword:"‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°", dpdf:"PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°", plag:"‡§™‡•ç‡§≤‡•á‡§ú‡§∞‡§ø‡§ú‡§º‡•ç‡§Æ ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç",
           checking:"‡§ú‡§æ‡§Å‡§ö ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...", allfixed:"‡§∏‡§æ‡§∞‡•Ä ‡§ó‡§≤‡§§‡§ø‡§Ø‡§æ‡§Å ‡§†‡•Ä‡§ï ‚úÖ", clicktofix:"‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§æ‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç",
           readingTime:"‡§™‡§¢‡§º‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø", textTools:"‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ü‡•Ç‡§≤‡•ç‡§∏", citation:"‡§â‡§¶‡•ç‡§ß‡§∞‡§£", 
           summarize:"‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂", vocab:"‡§∂‡§¨‡•ç‡§¶‡§æ‡§µ‡§≤‡•Ä", outline:"‡§Ü‡§â‡§ü‡§≤‡§æ‡§á‡§® ‡§¨‡§®‡§æ‡§è‡§Ç", timer:"‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§® ‡§ü‡§æ‡§á‡§Æ‡§∞",
           compare:"‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§§‡•Å‡§≤‡§®‡§æ", history:"‡§á‡§§‡§ø‡§π‡§æ‡§∏", exportMd:"‡§Æ‡§æ‡§∞‡•ç‡§ï‡§°‡§æ‡§â‡§® ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§", exportLatex:"LaTeX ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§",
           flashcards:"‡§´‡•ç‡§≤‡•à‡§∂‡§ï‡§æ‡§∞‡•ç‡§° ‡§¨‡§®‡§æ‡§è‡§Ç", wordGoal:"‡§∂‡§¨‡•ç‡§¶ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç", exportTxt:"‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§", exportHtml:"HTML ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§" },
      fr:{ title:"TextBuddy Pro - Assistant de R√©daction √âtudiant", write:"√âcrivez votre texte :", words:"Mots", chars:"Caract√®res", issues:"Probl√®mes",
           suggestions:"Suggestions", live:"Actif", support:"üôè Soutenez cet outil gratuit",
           donate:"üíñ Faire un don sur DeStream", check:"V√©rifier la grammaire", fix:"Tout corriger",
           dword:"T√©l√©charger Word", dpdf:"T√©l√©charger PDF", plag:"V√©rifier le plagiat",
           checking:"V√©rification...", allfixed:"Tout corrig√© ‚úÖ", clicktofix:"Cliquez sur les surbrillances rouges pour corriger",
           readingTime:"Temps de lecture", textTools:"Outils de texte", citation:"Citation", 
           summarize:"R√©sumer", vocab:"Vocabulaire", outline:"Cr√©er un plan", timer:"Minuteur d'√©tude",
           compare:"Comparer les textes", history:"Historique", exportMd:"Exporter Markdown", exportLatex:"Exporter LaTeX",
           flashcards:"Cr√©er des flashcards", wordGoal:"D√©finir un objectif de mots", exportTxt:"Exporter le texte", exportHtml:"Exporter HTML" },
      es:{ title:"TextBuddy Pro - Asistente de Escritura para Estudiantes", write:"Escribe tu texto:", words:"Palabras", chars:"Caracteres", issues:"Errores",
           suggestions:"Sugerencias", live:"Activo", support:"üôè Apoya esta herramienta gratuita",
           donate:"üíñ Donar en DeStream", check:"Revisar gram√°tica", fix:"Corregir todo",
           dword:"Descargar Word", dpdf:"Descargar PDF", plag:"Verificar plagio",
           checking:"Comprobando...", allfixed:"Todo corregido ‚úÖ", clicktofix:"Haz clic en los resaltados rojos para corregir",
           readingTime:"Tiempo de lectura", textTools:"Herramientas de texto", citation:"Cita", 
           summarize:"Resumir", vocab:"Vocabulario", outline:"Crear esquema", timer:"Temporizador de estudio",
           compare:"Comparar textos", history:"Historial", exportMd:"Exportar Markdown", exportLatex:"Exportar LaTeX",
           flashcards:"Crear tarjetas did√°cticas", wordGoal:"Establecer objetivo de palabras", exportTxt:"Exportar texto", exportHtml:"Exportar HTML" }
    };

    function setUI(lang){
      const t=T[lang]||T.en;
      document.getElementById('app-title').textContent=t.title;
      document.getElementById('label-write').textContent=t.write;
      document.getElementById('label-words').childNodes[0].nodeValue=t.words+": ";
      document.getElementById('label-chars').childNodes[0].nodeValue=t.chars+": ";
      document.getElementById('label-issues').childNodes[0].nodeValue=t.issues+": ";
      document.getElementById('label-reading-time').childNodes[0].nodeValue=t.readingTime+": ";
      document.getElementById('label-suggestions').textContent=t.suggestions;
      document.getElementById('label-live').textContent=t.live;
      document.getElementById('label-support').textContent=t.support;
      document.getElementById('label-donate').textContent=t.donate;
      checkBtn.textContent=t.check;
      fixAllBtn.textContent=t.fix;
      downloadDocBtn.textContent=t.dword;
      downloadPdfBtn.textContent=t.dpdf;
      plagBtn.textContent=t.plag;
      textToolsBtn.textContent=t.textTools;
      citationBtn.textContent=t.citation;
      document.getElementById('summarize-btn').textContent = t.summarize;
      document.getElementById('vocab-btn').textContent = t.vocab;
      document.getElementById('outline-btn').textContent = t.outline;
      document.getElementById('timer-btn').textContent = t.timer;
      document.getElementById('compare-btn').textContent = t.compare;
      document.getElementById('history-btn').textContent = t.history;
      document.getElementById('flashcard-btn').textContent = t.flashcards;
      document.getElementById('word-goal-btn').textContent = t.wordGoal;
      document.getElementById('export-md').textContent = t.exportMd;
      document.getElementById('export-latex').textContent = t.exportLatex;
      document.getElementById('export-txt').textContent = t.exportTxt;
      document.getElementById('export-html').textContent = t.exportHtml;
      localStorage.setItem('uiLang',lang);
    }
    uiLangSelect.addEventListener('change',()=>setUI(uiLangSelect.value));
    setUI(localStorage.getItem('uiLang')||'en'); uiLangSelect.value=localStorage.getItem('uiLang')||'en';

    // ====== THEME ======
    function applyTheme(dark){
      if(dark){ body.classList.add('dark'); darkToggle.textContent='‚òÄÔ∏è'; localStorage.setItem('darkMode','1'); }
      else{ body.classList.remove('dark'); darkToggle.textContent='üåô'; localStorage.setItem('darkMode','0'); }
    }
    darkToggle.addEventListener('click',()=>applyTheme(!body.classList.contains('dark')));
    applyTheme(localStorage.getItem('darkMode')==='1');

    // ====== TAB SYSTEM ======
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');
        
        // Update active tab button
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update active tab content
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
        
        // If stats tab is selected, update word cloud
        if (tabId === 'stats') {
          updateWordCloud();
        }
      });
    });

    // ====== COUNTS ======
    function updateCounts(){
      const txt = editor.innerText;
      const words = txt.trim() ? txt.trim().split(/\s+/).length : 0;
      wordCountEl.textContent = words;
      charCountEl.textContent = txt.length;
      
      // Calculate reading time (average 225 words per minute)
      const readingTime = Math.ceil(words / 225);
      readingTimeEl.textContent = `${readingTime} min`;
      
      // Calculate text statistics
      updateTextStatistics(txt);
      
      // Update word goal progress
      updateWordGoalProgress(words);
    }
    
    function updateTextStatistics(text) {
      // Count sentences (approximate)
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      sentenceCountEl.textContent = sentences;
      
      // Count paragraphs
      const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0).length;
      paragraphCountEl.textContent = paragraphs;
      
      // Calculate readability score (Flesch Reading Ease)
      if (text.trim().length > 0) {
        const words = text.trim().split(/\s+/).length;
        const syllables = countSyllables(text);
        const sentencesCount = Math.max(1, sentences);
        
        // Flesch Reading Ease formula
        const fleschScore = 206.835 - (1.015 * (words / sentencesCount)) - (84.6 * (syllables / words));
        readabilityScoreEl.textContent = Math.round(fleschScore);
        
        // Flesch-Kincaid Grade Level
        const gradeLevel = 0.39 * (words / sentencesCount) + 11.8 * (syllables / words) - 15.59;
        gradeLevelEl.textContent = gradeLevel.toFixed(1);
      } else {
        readabilityScoreEl.textContent = '-';
        gradeLevelEl.textContent = '-';
      }
    }
    
    function countSyllables(text) {
      // Simple syllable estimation for English text
      let syllableCount = 0;
      const words = text.toLowerCase().match(/\b[a-z]+\b/g) || [];
      
      words.forEach(word => {
        if (word.length <= 3) {
          syllableCount += 1;
          return;
        }
        
        word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
        word = word.replace(/^y/, '');
        
        const syllables = word.match(/[aeiouy]{1,2}/g);
        syllableCount += syllables ? syllables.length : 1;
      });
      
      return syllableCount;
    }
    
    function updateWordCloud() {
      const text = editor.innerText;
      if (!text.trim()) {
        wordCloudEl.innerHTML = '<div class="tips">No text to analyze</div>';
        return;
      }
      
      // Count word frequency
      const words = text.toLowerCase().match(/\b[a-z]+\b/g) || [];
      const wordCount = {};
      
      words.forEach(word => {
        if (word.length > 3) { // Only consider words longer than 3 characters
          wordCount[word] = (wordCount[word] || 0) + 1;
        }
      });
      
      // Convert to array and sort by frequency
      const wordArray = Object.entries(wordCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20); // Top 20 words
      
      // Clear previous cloud
      wordCloudEl.innerHTML = '';
      
      // Add words to cloud with size based on frequency
      wordArray.forEach(([word, count]) => {
        const span = document.createElement('span');
        span.className = 'cloud-word';
        span.textContent = word;
        span.style.fontSize = `${12 + count * 2}px`;
        span.style.opacity = `${0.6 + count * 0.1}`;
        wordCloudEl.appendChild(span);
      });
    }
    
    function updateWordGoalProgress(wordCount) {
      const goal = localStorage.getItem('wordGoal') || 500;
      const progress = Math.min(100, (wordCount / goal) * 100);
      document.getElementById('word-goal-progress').style.width = `${progress}%`;
      
      const goalStatus = document.getElementById('word-goal-status');
      if (goalStatus) {
        goalStatus.textContent = `${wordCount} of ${goal} words (${Math.round(progress)}%)`;
      }
      
      document.querySelector('#learning-tab .tips:nth-of-type(2)').textContent = 
        `${wordCount} of ${goal} words`;
    }

    editor.addEventListener('input', updateCounts); 
    editor.addEventListener('keyup', updateCounts); 
    updateCounts();

    // ====== HELPERS ======
    function stripHtml(html){ const d=document.createElement('div'); d.innerHTML=html; return d.textContent||''; }
    function infoNote(text){ const p=document.createElement('div'); p.className='tips'; p.textContent=text; suggestionsEl.prepend(p); }

    // ====== GRAMMAR CHECK (LanguageTool) ======
    async function runGrammar(){
      const text = editor.innerText;
      if(!text.trim()){ alert('Please write or paste text first!'); return; }
      const t=T[uiLangSelect.value]||T.en;
      suggestionsEl.innerHTML = `<div class="suggestion"><b>${t.checking}</b></div>`;
      issuesCountEl.textContent='0';

      try{
        const res = await fetch('https://api.languagetool.org/v2/check',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:new URLSearchParams({ text, language: langSelect.value })
        });
        const data = await res.json();
        displayMatches(data.matches || []);
        infoNote(t.clicktofix);
      }catch(e){
        suggestionsEl.innerHTML = `<div class="suggestion" style="color:var(--error)">Network error. Try again.</div>`;
      }
    }

    function displayMatches(matches){
      suggestionsEl.innerHTML='';
      issuesCountEl.textContent = matches.length;

      // Rebuild editor innerHTML with highlights using offsets
      const raw = editor.innerText;
      let out = '', last = 0;

      matches.forEach((m)=>{
        const off = m.offset, len = m.length;
        const before = raw.slice(last, off);
        const problem = raw.slice(off, off+len);
        const replacement = m.replacements?.[0]?.value || '';
        out += before + `<span class="highlight" data-replace="${replacement.replace(/"/g,'&quot;')}">${escapeHtml(problem)}</span>`;
        last = off + len;

        const sug = document.createElement('div');
        sug.className='suggestion';
        sug.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
            <span class="badge">${escapeHtml(m.rule?.category?.name || 'Issue')}</span>
            <span>${escapeHtml(m.message || 'Consider a change')}</span>
          </div>
          <div>Suggestion: <b>${replacement ? escapeHtml(replacement) : '‚Äî'}</b></div>`;
        suggestionsEl.appendChild(sug);
      });
      out += raw.slice(last);
      editor.innerHTML = out;
      updateCounts();
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }

    // Apply single fix on click
    editor.addEventListener('click',e=>{
      if(e.target.classList.contains('highlight')){
        const rep = e.target.dataset.replace || '';
        if(rep){ e.target.outerHTML = rep; updateCounts(); }
      }
    });

    // Fix all
    fixAllBtn.addEventListener('click',()=>{
      const hs = editor.querySelectorAll('.highlight');
      hs.forEach(h=>{ const rep=h.dataset.replace; if(rep){ h.outerHTML = rep; } });
      issuesCountEl.textContent='0';
      suggestionsEl.innerHTML = `<div class="suggestion">${(T[uiLangSelect.value]||T.en).allfixed}</div>`;
      updateCounts();
    });

    checkBtn.addEventListener('click', runGrammar);

    // ====== TEXT TOOLS ======
    textToolsBtn.addEventListener('click', function() {
      const text = editor.innerText;
      if (!text.trim()) {
        alert('Please enter some text first!');
        return;
      }
      
      // Create a menu of text tools
      const tool = prompt('Choose a text tool:\n1. UPPERCASE\n2. lowercase\n3. Title Case\n4. Sentence case\n5. Remove extra spaces\n6. Reverse text', '1');
      
      switch(tool) {
        case '1':
          editor.innerText = text.toUpperCase();
          break;
        case '2':
          editor.innerText = text.toLowerCase();
          break;
        case '3':
          editor.innerText = text.replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
          });
          break;
        case '4':
          editor.innerText = text.toLowerCase().replace(/(^\s*|[.!?]\s+)(\w)/g, function(match, p1, p2) {
            return p1 + p2.toUpperCase();
          });
          break;
        case '5':
          editor.innerText = text.replace(/\s+/g, ' ').trim();
          break;
        case '6':
          editor.innerText = text.split('').reverse().join('');
          break;
        default:
          // Do nothing if canceled or invalid
      }
      
      updateCounts();
    });

    // ====== CITATION GENERATOR ======
    citationBtn.addEventListener('click', function() {
      citationModal.style.display = 'flex';
    });

    document.getElementById('generate-citation').addEventListener('click', function() {
      const style = document.getElementById('citation-style').value;
      const sourceType = document.getElementById('source-type').value;
      const author = document.getElementById('author-name').value;
      const title = document.getElementById('source-title').value;
      const year = document.getElementById('publication-year').value;
      const publisher = document.getElementById('publisher').value;
      const url = document.getElementById('url').value;
      
      let citation = '';
      
      if (style === 'apa') {
        if (sourceType === 'book') {
          citation = `${author} (${year}). ${title}. ${publisher}.`;
        } else if (sourceType === 'article') {
          citation = `${author} (${year}). ${title}. Journal Name, Volume(Issue), Page range.`;
        } else if (sourceType === 'website') {
          citation = `${author} (${year}). ${title}. Retrieved from ${url}`;
        }
      } else if (style === 'mla') {
        if (sourceType === 'book') {
          citation = `${author}. ${title}. ${publisher}, ${year}.`;
        } else if (sourceType === 'article') {
          citation = `${author}. "${title}." Journal Name, vol. Volume, no. Issue, ${year}, pp. Page range.`;
        } else if (sourceType === 'website') {
          citation = `${author}. "${title}." Website Name, ${year}, ${url}.`;
        }
      } else if (style === 'chicago') {
        if (sourceType === 'book') {
          citation = `${author}. ${title}. ${publisher}, ${year}.`;
        } else if (sourceType === 'article') {
          citation = `${author}. "${title}." Journal Name Volume, no. Issue (${year}): Page range.`;
        } else if (sourceType === 'website') {
          citation = `${author}. "${title}." ${publisher}. Last modified ${year}. ${url}.`;
        }
      }
      
      document.getElementById('citation-result').textContent = citation;
    });

    // ====== STUDY TIMER ======
    document.getElementById('timer-btn').addEventListener('click', function() {
      timerModal.style.display = 'flex';
    });

    let timerInterval;
    let timerMinutes = 25;
    let timerSeconds = 0;
    let isTimerRunning = false;

    function updateTimerDisplay() {
      document.getElementById('timer-display').textContent = 
        `${timerMinutes.toString().padStart(2, '0')}:${timerSeconds.toString().padStart(2, '0')}`;
    }

    document.getElementById('start-timer').addEventListener('click', function() {
      if (!isTimerRunning) {
        isTimerRunning = true;
        timerInterval = setInterval(function() {
          if (timerSeconds === 0) {
            if (timerMinutes === 0) {
              clearInterval(timerInterval);
              alert('Timer completed!');
              isTimerRunning = false;
              return;
            }
            timerMinutes--;
            timerSeconds = 59;
          } else {
            timerSeconds--;
          }
          updateTimerDisplay();
        }, 1000);
      }
    });

    document.getElementById('pause-timer').addEventListener('click', function() {
      clearInterval(timerInterval);
      isTimerRunning = false;
    });

    document.getElementById('reset-timer').addEventListener('click', function() {
      clearInterval(timerInterval);
      isTimerRunning = false;
      const preset = document.getElementById('timer-preset').value;
      timerMinutes = parseInt(preset);
      timerSeconds = 0;
      updateTimerDisplay();
    });

    document.getElementById('timer-preset').addEventListener('change', function() {
      if (!isTimerRunning) {
        const preset = this.value;
        timerMinutes = parseInt(preset);
        timerSeconds = 0;
        updateTimerDisplay();
      }
    });

    // Initialize timer
    updateTimerDisplay();

    // ====== TEXT SUMMARIZATION ======
    document.getElementById('summarize-btn').addEventListener('click', function() {
      const text = editor.innerText;
      if (!text.trim()) {
        alert('Please enter some text to summarize!');
        return;
      }
      
      // Simple summarization by extracting important sentences
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const importantSentences = [];
      
      // Look for sentences that might be important (contain keywords, are longer, etc.)
      for (let i = 0; i < sentences.length; i++) {
        const sentence = sentences[i].trim();
        if (sentence.length > 50 && 
            (sentence.includes('important') || 
             sentence.includes('conclusion') || 
             sentence.includes('result') || 
             sentence.includes('find') ||
             sentence.split(' ').length > 8)) {
          importantSentences.push(sentence);
        }
        
        // Also include first and last sentences
        if (i === 0 || i === sentences.length - 1) {
          if (!importantSentences.includes(sentence)) {
            importantSentences.push(sentence);
          }
        }
        
        // Limit to 5 sentences for summary
        if (importantSentences.length >= 5) break;
      }
      
      // If no "important" sentences found, take first few sentences
      if (importantSentences.length === 0) {
        importantSentences.push(...sentences.slice(0, Math.min(3, sentences.length)));
      }
      
      const summary = importantSentences.join('. ') + '.';
      alert('Summary:\n\n' + summary);
    });

    // ====== VOCABULARY ENHANCEMENT ======
    document.getElementById('vocab-btn').addEventListener('click', function() {
      const text = editor.innerText;
      if (!text.trim()) {
        alert('Please enter some text first!');
        return;
      }
      
      // Simple vocabulary enhancement by suggesting alternatives for common words
      const commonWords = {
        'good': ['excellent', 'superb', 'outstanding', 'remarkable', 'exceptional'],
        'bad': ['poor', 'inferior', 'substandard', 'unsatisfactory', 'inadequate'],
        'big': ['large', 'sizeable', 'substantial', 'considerable', 'ample'],
        'small': ['tiny', 'miniature', 'compact', 'petite', 'minuscule'],
        'important': ['crucial', 'vital', 'essential', 'paramount', 'critical'],
        'interesting': ['fascinating', 'engaging', 'compelling', 'intriguing', 'captivating'],
        'see': ['observe', 'witness', 'perceive', 'discern', 'notice'],
        'get': ['obtain', 'acquire', 'secure', 'procure', 'attain']
      };
      
      let enhancedText = text;
      let suggestions = [];
      
      for (const [word, alternatives] of Object.entries(commonWords)) {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        if (regex.test(text)) {
          enhancedText = enhancedText.replace(regex, `<span class="highlight" data-replace="${alternatives[0]}">${word}</span>`);
          suggestions.push(`Consider replacing "${word}" with: ${alternatives.join(', ')}`);
        }
      }
      
      if (suggestions.length > 0) {
        editor.innerHTML = enhancedText;
        suggestionsEl.innerHTML = '<div class="suggestion"><b>Vocabulary Suggestions:</b></div>';
        suggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'suggestion';
          div.textContent = suggestion;
          suggestionsEl.appendChild(div);
        });
      } else {
        alert('No common words found that could be enhanced. Try using more descriptive language!');
      }
    });

    // ====== OUTLINE GENERATOR ======
    document.getElementById('outline-btn').addEventListener('click', function() {
      const text = editor.innerText;
      if (!text.trim()) {
        alert('Please enter some text first!');
        return;
      }
      
      // Extract headings and main points to create an outline
      const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
      let outline = '';
      
      paragraphs.forEach(para => {
        // Check if paragraph seems like a heading
        if (para.length < 100 && !para.includes('.') && !para.includes('!') && !para.includes('?')) {
          outline += `# ${para}\n`;
        } else {
          // Extract first sentence as summary
          const firstSentence = para.split(/[.!?]/)[0];
          if (firstSentence && firstSentence.length > 10) {
            outline += `- ${firstSentence}\n`;
          }
        }
      });
      
      if (outline) {
        alert('Generated Outline:\n\n' + outline);
      } else {
        alert('Could not generate a clear outline from this text.');
      }
    });

    // ====== COMPARE TEXTS ======
    document.getElementById('compare-btn').addEventListener('click', function() {
      comparisonModal.style.display = 'flex';
      document.getElementById('original-text').innerText = editor.innerText;
      document.getElementById('revised-text').innerText = '';
    });

    document.getElementById('compare-texts-btn').addEventListener('click', function() {
      const original = document.getElementById('original-text').innerText;
      const revised = document.getElementById('revised-text').innerText;
      
      if (!original || !revised) {
        alert('Please enter both original and revised texts!');
        return;
      }
      
      // Simple text comparison by word count and length
      const originalWords = original.split(/\s+/).length;
      const revisedWords = revised.split(/\s+/).length;
      const originalChars = original.length;
      const revisedChars = revised.length;
      
      const result = `
        <div class="suggestion">
          <h4>Comparison Results</h4>
          <p>Original: ${originalWords} words, ${originalChars} characters</p>
          <p>Revised: ${revisedWords} words, ${revisedChars} characters</p>
          <p>Difference: ${revisedWords - originalWords} words, ${revisedChars - originalChars} characters</p>
        </div>
      `;
      
      document.getElementById('comparison-result').innerHTML = result;
    });

    // ====== FLASHCARDS ======
    document.getElementById('flashcard-btn').addEventListener('click', function() {
      flashcardModal.style.display = 'flex';
      updateFlashcardList();
    });

    document.getElementById('add-flashcard').addEventListener('click', function() {
      const term = document.getElementById('flashcard-term').value;
      const definition = document.getElementById('flashcard-definition').value;
      
      if (!term || !definition) {
        alert('Please enter both term and definition!');
        return;
      }
      
      const flashcards = JSON.parse(localStorage.getItem('textbuddy_flashcards') || '[]');
      flashcards.push({ term, definition });
      localStorage.setItem('textbuddy_flashcards', JSON.stringify(flashcards));
      
      document.getElementById('flashcard-term').value = '';
      document.getElementById('flashcard-definition').value = '';
      
      updateFlashcardList();
    });

    function updateFlashcardList() {
      const flashcards = JSON.parse(localStorage.getItem('textbuddy_flashcards') || '[]');
      const flashcardList = document.getElementById('flashcard-list');
      flashcardList.innerHTML = '';
      
      if (flashcards.length === 0) {
        flashcardList.innerHTML = '<div class="tips">No flashcards yet</div>';
        return;
      }
      
      flashcards.forEach((card, index) => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.innerHTML = `
          <div><strong>${card.term}</strong></div>
          <div>${card.definition}</div>
          <button class="tool-btn" data-index="${index}" style="margin-top: 8px;">Remove</button>
        `;
        
        div.querySelector('button').addEventListener('click', function() {
          const idx = parseInt(this.getAttribute('data-index'));
          flashcards.splice(idx, 1);
          localStorage.setItem('textbuddy_flashcards', JSON.stringify(flashcards));
          updateFlashcardList();
        });
        
        flashcardList.appendChild(div);
      });
    }

    // Flashcard flip functionality
    document.querySelectorAll('.flashcard').forEach(card => {
      card.addEventListener('click', function() {
        this.classList.toggle('flipped');
      });
    });

    // ====== WORD GOAL ======
    document.getElementById('word-goal-btn').addEventListener('click', function() {
      wordGoalModal.style.display = 'flex';
    });

    document.getElementById('set-word-goal').addEventListener('click', function() {
      const goal = parseInt(document.getElementById('word-goal-input').value);
      
      if (isNaN(goal) || goal <= 0) {
        alert('Please enter a valid word goal!');
        return;
      }
      
      localStorage.setItem('wordGoal', goal);
      updateWordGoalProgress(editor.innerText.split(/\s+/).length);
      
      document.getElementById('word-goal-status').textContent = `Word goal set to ${goal} words!`;
    });

    // ====== HISTORY FEATURE ======
    document.getElementById('history-btn').addEventListener('click', function() {
      historyModal.style.display = 'flex';
      updateHistoryList();
    });

    function updateHistoryList() {
      const history = JSON.parse(localStorage.getItem('textbuddy_history') || '[]');
      const historyList = document.getElementById('history-list');
      historyList.innerHTML = '';
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="tips">No history yet</div>';
        return;
      }
      
      history.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        // Create preview text
        const preview = item.text.length > 100 ? item.text.substring(0, 100) + '...' : item.text;
        const date = new Date(item.timestamp).toLocaleString();
        
        div.innerHTML = `
          <div><strong>${date}</strong></div>
          <div class="tips">${preview}</div>
        `;
        
        div.addEventListener('click', function() {
          editor.innerText = item.text;
          updateCounts();
          historyModal.style.display = 'none';
        });
        
        historyList.appendChild(div);
      });
    }

    // Save to history periodically
    setInterval(function() {
      const text = editor.innerText;
      if (text.trim()) {
        const history = JSON.parse(localStorage.getItem('textbuddy_history') || '[]');
        
        // Add new entry if different from last one
        if (history.length === 0 || history[history.length - 1].text !== text) {
          history.push({
            text: text,
            timestamp: Date.now()
          });
          
          // Keep only last 10 entries
          if (history.length > 10) {
            history.shift();
          }
          
          localStorage.setItem('textbuddy_history', JSON.stringify(history));
        }
      }
    }, 30000); // Save every 30 seconds

    // ====== EXPORT OPTIONS ======
    document.getElementById('export-md').addEventListener('click', function() {
      const text = editor.innerText;
      const blob = new Blob(['\ufeff', text], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'document.md' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('export-latex').addEventListener('click', function() {
      const text = editor.innerText;
      const latexContent = `\\documentclass{article}\n\\begin{document}\n${text}\n\\end{document}`;
      const blob = new Blob(['\ufeff', latexContent], { type: 'application/x-latex' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'document.tex' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('export-txt').addEventListener('click', function() {
      const text = editor.innerText;
      const blob = new Blob(['\ufeff', text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'document.txt' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('export-html').addEventListener('click', function() {
      const text = editor.innerHTML;
      const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Document</title></head><body>${text}</body></html>`;
      const blob = new Blob(['\ufeff', htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'document.html' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ====== DOWNLOADS ======
    downloadDocBtn.addEventListener('click',()=>{
      const text = editor.innerText;
      const blob = new Blob(['\ufeff', text], { type:'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:'Essay.doc' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    downloadPdfBtn.addEventListener('click',()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const margin = 40, width = 515;
      const text = editor.innerText;
      const lines = doc.splitTextToSize(text, width);
      doc.text(lines, margin, margin+10);
      doc.save('Essay.pdf');
    });

    // ====== PLAIGARISM (RapidAPI) ======
    plagBtn.addEventListener('click', async ()=>{
      const text = editor.innerText.trim();
      if(!text){ alert('Please write or paste text first!'); return; }
      const t=T[uiLangSelect.value]||T.en;
      suggestionsEl.innerHTML = `<div class="suggestion"><b>${t.checking} (plagiarism)</b></div>`;
      try{
        const res = await fetch('https://plagiarism-checker-api.p.rapidapi.com/plagiarism',{
          method:'POST',
          headers:{
            'content-type':'application/json',
            'X-RapidAPI-Key':'Bi5r4HaHUQ4voaUEu3HD1xICgALanY0gSRb3rlbldaa17c95',
            'X-RapidAPI-Host':'plagiarism-checker-api.p.rapidapi.com'
          },
          body: JSON.stringify({ text })
        });
        const result = await res.json();
        const plag = result.percentPlagiarism ?? result.plagiarism ?? 0;
        const uniq = result.percentUnique ?? (100 - (+plag || 0));
        suggestionsEl.innerHTML = `
          <div class="suggestion">
            <div style="font-weight:800;margin-bottom:6px">Plagiarism Report</div>
            <div>Plagiarized: <b>${Math.round(plag)}%</b> ‚ùå</div>
            <div>Unique: <b>${Math.round(uniq)}%</b> ‚úÖ</div>
          </div>`;
      }catch(e){
        suggestionsEl.innerHTML = `<div class="suggestion" style="color:var(--error)">Error: Unable to check plagiarism.</div>`;
      }
    });

    // ====== MODAL CONTROLS ======
    closeModalBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        citationModal.style.display = 'none';
        timerModal.style.display = 'none';
        historyModal.style.display = 'none';
        comparisonModal.style.display = 'none';
        flashcardModal.style.display = 'none';
        wordGoalModal.style.display = 'none';
      });
    });

    window.addEventListener('click', function(event) {
      if (event.target === citationModal) {
        citationModal.style.display = 'none';
      }
      if (event.target === timerModal) {
        timerModal.style.display = 'none';
      }
      if (event.target === historyModal) {
        historyModal.style.display = 'none';
      }
      if (event.target === comparisonModal) {
        comparisonModal.style.display = 'none';
      }
      if (event.target === flashcardModal) {
        flashcardModal.style.display = 'none';
      }
      if (event.target === wordGoalModal) {
        wordGoalModal.style.display = 'none';
      }
    });

    // ====== QUALITY OF LIFE ======
    // Paste as plain text (avoid weird HTML)
    editor.addEventListener('paste', (e)=>{
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text);
    });

    // Simple debounce for heavy actions if you ever auto-check
    function debounce(fn, wait=500){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

    // Initialize word goal
    if (!localStorage.getItem('wordGoal')) {
      localStorage.setItem('wordGoal', 500);
    }
    updateWordGoalProgress(editor.innerText.split(/\s+/).length);

  </script>
</body>
</html>
